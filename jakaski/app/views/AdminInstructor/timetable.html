#{extends 'content.html' /}

#{set 'moreStyles'}
<link rel="stylesheet" href="@{'/public/stylesheets/dhtmlxscheduler_dhx_terrace.css'}" type="text/css" charset="utf-8">
#{/set}
#{set 'moreScripts'}
<script src="@{'/public/javascripts/dhtmlxscheduler.js'}" type="text/javascript" charset="utf-8"></script>
<script src="@{'/public/javascripts/dhtmlxscheduler_timeline.js'}" type="text/javascript" charset="utf-8"></script>
<script src="@{'/public/javascripts/dhtmlxscheduler_dhx_terrace.js'}" type="text/javascript" charset="utf-8"></script>
#{/set}

<h1 class="page-title">
  <i class="icon-calendar"></i>
  &{'timetable'}
</h1>

<div class="widget">
  <div class="widget-content">
    <div id="scheduler_here" class="dhx_cal_container" style='width: 100%; height: 600px'>
      <div class="dhx_cal_navline">
        <div class="dhx_cal_prev_button">&nbsp;</div>
        <div class="dhx_cal_next_button">&nbsp;</div>
        <div class="dhx_cal_today_button"></div>
        <div class="dhx_cal_date"></div>
        <div class="dhx_cal_tab" name="timeline_tab">Timeline</div>
      </div>
      <div class="dhx_cal_header"></div>
      <div class="dhx_cal_data"></div>
    </div>
  </div>

<script type="text/javascript" charset="utf-8">
  // Helper functions
  function lessonsToEvents(data) {
      var events = [];

      $.each(data, function(index, value) {
          var lesson = value.lesson;
          var instructorId = lesson.instructor.replace("/instructor/", "");
          events.push({start_date: lesson.start, end_date: lesson.end, text: lesson.note, instructor_id: instructorId});
      });

      return events;
  }

  function loadEvents() {
      var date = new Date();
      var queryDate = "date=" + date.getFullYear() + "-" + (date.getMonth() + 1) + "-" + date.getDate();
      var getLessons = #{jsRoute @rest.QueryController.getLessons() /};

      $.ajax({
          url: getLessons.url(),
          type: getLessons.method,
          data: queryDate,
      }).done(function(data) {
          scheduler.parse(lessonsToEvents(data.result), "json");
      });
  }

  // Timeline configuration
  scheduler.createTimelineView({
    name: "timeline",
    render: "bar",
    x_unit: "minute",
    x_date: "%H:%i",
    x_step: 60,
    x_start: 8,
    x_size: 11,
    y_property:"instructor_id",
    y_unit:[
      {key:223, label:"Michal"},
      {key:2, label:"John Williams"},
      {key:3, label:"David Miller"},
      {key:4, label:"Linda Brown"}
    ]
  });

  // Scheduler configuration
  scheduler.config.api_date="%Y-%m-%d %H:%i";
  scheduler.config.xml_date="%Y-%m-%d %H:%i";
  scheduler.init('scheduler_here', null, "timeline");
  
  // Data loading
  loadEvents();
</script>
</div>